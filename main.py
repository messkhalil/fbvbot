from telegram import Update
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes
)
from downloader import download_facebook_video
from config import BOT_TOKEN, DOWNLOAD_FOLDER
import os
import shutil

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨"""
    welcome_msg = """
Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ!

ğŸ“Œ ÙÙ‚Ø· Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„Ù‡ Ù„Ùƒ.

âš™ï¸ Ø§Ù„Ù…ÙŠØ²Ø§Øª:
- ÙŠØ¯Ø¹Ù… Ù…Ø¹Ø¸Ù… Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ
- ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
- ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø·ÙˆÙŠÙ„Ø© (Ø­ØªÙ‰ 50MB)
    """
    await update.message.reply_text(welcome_msg)

async def handle_video_request(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ"""
    user = update.message.from_user
    print(f"Ø·Ù„Ø¨ ØªØ­Ù…ÙŠÙ„ Ù…Ù† {user.first_name} (@{user.username}): {update.message.text}")
    
    if not update.message.text:
        await update.message.reply_text("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙ‚Ø·")
        return
    
    try:
        # Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø£Ù† Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        status_msg = await update.message.reply_text("â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...")
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        video_path = download_facebook_video(update.message.text)
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        await update.message.reply_video(
            video=open(video_path, 'rb'),
            caption="âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­",
            supports_streaming=True,
            width=1280,
            height=720
        )
        
        # Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        await context.bot.delete_message(
            chat_id=update.message.chat_id,
            message_id=status_msg.message_id
        )
        
        # Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¤Ù‚Øª
        os.remove(video_path)
        
    except Exception as e:
        error_msg = f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„: {str(e)}"
        await update.message.reply_text(error_msg)
        print(error_msg)

def cleanup():
    """ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¹Ù†Ø¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª"""
    if os.path.exists(DOWNLOAD_FOLDER):
        shutil.rmtree(DOWNLOAD_FOLDER)

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    application = Application.builder().token(BOT_TOKEN).build()
    
    # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_video_request))
    
    # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    import atexit
    atexit.register(cleanup)
    
    # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
    print("ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„...")
    application.run_polling()

if __name__ == '__main__':
    main()